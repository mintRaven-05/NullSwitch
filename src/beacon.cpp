#include "../include/beacon.h"
#include "../include/globals.h"
#include <regex>

uint8_t wifi_channels[] = {3, 7, 11};
bool enable_wpa2_mode = false;
bool pad_ssid_names = true;

char blank_ssid[MAX_SSID_LENGTH];
uint8_t current_channel_idx = 0;
uint8_t device_mac[MAC_ADDRESS_LENGTH];
uint8_t active_channel = 1;
uint32_t time_now = 0;
uint32_t frame_size = 0;
uint32_t sent_packets = 0;
uint32_t last_attack = 0;
uint32_t rate_check_time = 0;

uint8_t beacon_frame[BEACON_FRAME_SIZE] = {
    0x80, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0x01, 0x02, 0x03, 0x04, 0x05, 0x06,
    0x01, 0x02, 0x03, 0x04, 0x05, 0x06,
    0x00, 0x00, 0x83, 0x51, 0xf7, 0x8f,
    0x0f, 0x00, 0x00, 0x00, 0xe8, 0x03,
    0x31, 0x00, 0x00, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 
    0x20, 0x20, 0x20, 0x20, 0x20, 0x20,

    0x01, 0x08, 0x82, 0x84, 0x8b, 
    0x96, 0x24, 0x30, 0x48, 0x6c,

    0x03, 0x01, 0x01,

    0x30, 0x18, 0x01, 0x00, 0x00, 0x0f, 0xac, 0x02, 0x02, 0x00, 0x00, 0x0f,
    0xac, 0x04, 0x00, 0x0f, 0xac, 0x04, 0x01, 0x00, 0x00, 0x0f, 0xac, 0x02,
    0x00, 0x00};

void switch_channel() {
  if (sizeof(wifi_channels) > 1) {
    uint8_t next_ch = wifi_channels[current_channel_idx];
    current_channel_idx++;
    if (current_channel_idx >= sizeof(wifi_channels))
      current_channel_idx = 0;

    if (next_ch != active_channel && next_ch >= 1 && next_ch <= 14) {
      active_channel = next_ch;
      wifi_set_channel(active_channel);
    }
  }
}
  

void generate_random_mac() {
  for (int idx = 0; idx < MAC_ADDRESS_LENGTH; idx++) {
    device_mac[idx] = random(256);
  }
}
void initialize_system() {
  for (int idx = 0; idx < MAX_SSID_LENGTH; idx++)
    blank_ssid[idx] = ' ';

  randomSeed(os_random());
  setup_beacon_frame();
  generate_random_mac();

  time_now = millis();

  WiFi.mode(WIFI_OFF);
  wifi_set_opmode(STATION_MODE);
  wifi_set_channel(wifi_channels[0]);
}